<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Formulario Reservar</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" th:href="@{/css/vecino_sidebar.css}">
    </head>

    <body>
        <div class="wrapper">
            <!-- Sidebar -->
            <div th:replace="~{fragments/sidebar-vecino :: sidebar}"></div>
            <div class="main">
                <!-- Navbar -->
                <div th:replace="~{fragments/navbar-vecino :: navbar}"></div>

                <!-- Contenido principal -->
                <main class="content">
                    <div class="container-fluid p-4">

                        <!-- Opciones de Reservar -->
                        <div th:replace="~{fragments/opciones-reserva :: opciones-reserva}"></div>

                        <div class="container mt-4">
                            <div class="card p-4 shadow rounded">
                                <h4 class="mb-4">Datos de la Reserva</h4>
                                <form th:action="@{/vecino/reservas/guardar}" th:object="${reserva}" method="post">
                                    <!-- SEDE -->
                                    <div class="mb-3">
                                        <label class="form-label">Sede</label>
                                        <select id="sede-select" class="form-select" required>
                                            <option value="">Seleccione una sede</option>
                                            <option th:each="sede : ${listaSedes}" th:value="${sede.idsede}" th:text="${sede.nombre}"></option>
                                        </select>
                                    </div>

                                    <!-- SERVICIO (se cargará según sede) -->
                                    <div class="mb-3">
                                        <label class="form-label">Servicio</label>
                                        <select id="servicio-select" name="sedeServicio.idSedeServicio" class="form-select" required>
                                            <option value="">Seleccione una sede primero</option>
                                        </select>
                                    </div>

                                    <!-- FECHA -->
                                    <div class="mb-3">
                                        <label class="form-label">Fecha de Reserva</label>
                                        <input type="date" class="form-control" id="fechaReserva" name="fechaReserva" th:field="*{fechaReserva}" required>
                                    </div>

                                    <!-- HORARIO DISPONIBLE -->
                                    <div class="mb-3">
                                        <label class="form-label">Horario Disponible</label>
                                        <select class="form-select" name="horarioDisponible.idhorario" id="horarioDisponible" required>
                                            <option value="">Seleccione un horario</option>
                                            <option th:each="horario : ${listaHorarios}"
                                                    th:value="${horario.idhorario}"
                                                    th:text="${#temporals.format(horario.horaInicio, 'HH:mm')} + ' - ' + ${#temporals.format(horario.horaFin, 'HH:mm')}">
                                            </option>
                                        </select>
                                    </div>

                                    <button type="submit" class="btn btn-primary">Reservar</button>
                                    <a th:href="@{/vecino/reservas}" class="btn btn-secondary">Cancelar</a>
                                </form>

                                <script>
                                    const servicioSelect = document.getElementById("servicio-select");
                                    const sedeSelect = document.getElementById("sede-select");
                                    const fechaInput = document.getElementById("fechaReserva");
                                    const horarioSelect = document.getElementById("horarioDisponible");

                                    // Cargar servicios según sede seleccionada
                                    sedeSelect.addEventListener("change", function () {
                                        const sedeId = this.value;
                                        servicioSelect.innerHTML = '<option value="">Cargando servicios...</option>';
                                        horarioSelect.innerHTML = '<option value="">Seleccione servicio y fecha</option>';

                                        fetch(`/api/servicios-por-sede/${sedeId}`)
                                            .then(res => res.json())
                                            .then(data => {
                                                servicioSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
                                                data.forEach(s => {
                                                    let option = document.createElement("option");
                                                    option.value = s.idSedeServicio;
                                                    option.textContent = s.nombre;
                                                    servicioSelect.appendChild(option);
                                                });
                                            })
                                            .catch(err => {
                                                console.error("Error cargando servicios", err);
                                                servicioSelect.innerHTML = '<option>Error al cargar</option>';
                                            });
                                    });

                                    // Cargar horarios disponibles según servicio y fecha
                                    function cargarHorariosDisponibles() {
                                        const sedeServicioId = servicioSelect.value;
                                        const fecha = fechaInput.value;

                                        if (!sedeServicioId || sedeServicioId === "undefined") {
                                            horarioSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
                                            return;
                                        }

                                        if (!fecha) {
                                            return;
                                        }

                                        fetch(`/api/horarios-disponibles?sedeServicioId=${sedeServicioId}&fecha=${fecha}`)
                                            .then(res => res.json())
                                            .then(data => {
                                                horarioSelect.innerHTML = '';

                                                if (data.length === 0) {
                                                    const opt = document.createElement("option");
                                                    opt.value = "";
                                                    opt.textContent = "No hay horarios disponibles";
                                                    horarioSelect.appendChild(opt);
                                                } else {
                                                    const opt = document.createElement("option");
                                                    opt.value = "";
                                                    opt.textContent = "Seleccione un horario";
                                                    opt.disabled = true;
                                                    opt.selected = true;
                                                    horarioSelect.appendChild(opt);

                                                    data.forEach(horario => {
                                                        const opt = document.createElement("option");
                                                        opt.value = horario.idhorario;
                                                        opt.textContent = `${horario.horaInicio} - ${horario.horaFin}`;
                                                        horarioSelect.appendChild(opt);
                                                    });
                                                }
                                            })
                                            .catch(error => {
                                                horarioSelect.innerHTML = '<option>Error al cargar horarios</option>';
                                                console.error("Error al cargar horarios:", error);
                                            });
                                    }

                                    fechaInput.addEventListener("change", cargarHorariosDisponibles);
                                    servicioSelect.addEventListener("change", cargarHorariosDisponibles);
                                </script>

                            </div>
                        </div>
                    </div>
                </main>

                <footer class="footer mt-auto py-3">
                    <div class="text-center mt-5 mb-3">
                        <img th:src="@{/img/logo_sanmiguel.png}" alt="Logo" height="60">
                    </div>
                    <div class="container text-center text-muted">
                        Municipalidad de San Miguel © 2025
                    </div>
                </footer>
            </div>
        </div>

        <!-- Scripts -->
        <script src="https://unpkg.com/feather-icons"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            feather.replace();
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const toggle = document.querySelector(".js-sidebar-toggle");
                const sidebar = document.getElementById('sidebar');
                if (toggle) {
                    toggle.addEventListener("click", function (e) {
                        e.preventDefault();
                        document.body.classList.toggle("sidebar-collapsed");
                    });
                }
            });
        </script>

    </body>
</html>
